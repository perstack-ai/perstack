# Security

This document describes the security model of Perstack and provides guidance for secure usage.

## TL;DR

- **MCP Skills are RCE.** Never run Skills from untrusted sources without sandboxing.
- **Docker runtime is secure by default.** The `local` runtime has no isolation â€” use it only for trusted environments.
- **Windows users: WSL2 + Docker required.** Native Windows lacks critical security primitives.
- **Never mount secrets into workspace.** Skills can read everything in the mounted directory.
- **Treat stdout as untrusted.** Events are generated by untrusted code (LLM + Skills).

---

## Quick Start Security

Minimum security practices before running any Expert:

1. **Use the default `docker` runtime** â€” it provides container isolation and network restrictions
2. **Review `requiredEnv`** before providing API keys to Skills
3. **Minimize `allowedDomains`** â€” default to deny, add only what's needed
4. **Isolate workspace** â€” never mount directories containing secrets or credentials
5. **Sanitize stdout** â€” treat all output events as untrusted input

```bash
perstack run my-expert "query"
```

---

## Trust Model (Defense in Depth)

LLM outputs and MCP Skills are inherently untrusted. Perstack uses a four-layer defense model where the two upper layers protect against the untrusted core:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Sandbox (Infrastructure)                         â”‚  â† Outermost defense
â”‚    Docker, ECS, Workers provide isolation           â”‚
â”‚    Runtime doesn't enforce boundaries - infra does  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. Experts (perstack.toml)                          â”‚
â”‚    Trusted configuration defining behavior          â”‚
â”‚    Context isolation between Experts                â”‚
â”‚    requiredEnv, pick/omit limit skill capabilities  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. Skills (MCP Servers)                             â”‚  â† Untrusted (RCE)
â”‚    Executes arbitrary npm packages                  â”‚
â”‚    Full code execution within sandbox               â”‚
â”‚    Can exfiltrate secrets passed via requiredEnv    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. LLM Outputs                                      â”‚  â† Untrusted core
â”‚    Probabilistic, prompt injection possible         â”‚
â”‚    Decides which skills to invoke                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Layer 1: Sandbox (Infrastructure)

The outermost defense layer. Perstack is designed to run inside sandboxed infrastructure:
- Docker containers with network isolation
- Cloud platforms (ECS, Cloud Run, Workers)
- Resource limits and capability dropping

**Key principle:** The runtime doesn't enforce security boundaries â€” infrastructure does. This is sandbox-first design.

### Layer 2: Experts (perstack.toml)

Experts are trusted configuration files that define:
- Which skills (MCP servers) to use
- Environment variables to pass to skills (`requiredEnv`)
- Tool filtering (`pick`/`omit`)
- Context isolation between Experts

**Risk:** A malicious `perstack.toml` from an untrusted source could reference malicious skills or request sensitive environment variables.

**Mitigation:** Only use expert configurations from trusted sources. Review `requiredEnv` declarations before running.

### Layer 3: Skills (MCP Servers)

**IMPORTANT:** MCP skills are **untrusted code** equivalent to RCE. A malicious MCP server can:
- Exfiltrate secrets passed via `requiredEnv`
- Execute arbitrary commands within the sandbox
- Access the network (restricted with the default `docker` runtime)
- Read sensitive files (restricted with the default `docker` runtime)

**Mitigation:**
- Use the default `docker` runtime
- Only install skills from trusted sources
- Review `requiredEnv` before providing API keys
- Prefer skills with minimal permission requirements

### Layer 4: LLM Outputs

LLM responses are probabilistic and can be manipulated via prompt injection:
- Execute destructive commands
- Read/exfiltrate sensitive data
- Deviate from intended behavior

**Mitigation:**
- Use the default `docker` runtime
- Review tool call history in development
- Limit max-steps to prevent runaway execution

### Boundary Points

The sandbox has only two controlled interfaces with the host system:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sandbox (Container)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Perstack Runtime                             â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ Expert execution                         â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ MCP skill servers                        â”‚  â”‚
â”‚  â”‚  â””â”€â”€ @perstack/base tools                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     â”‚                     â”‚         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚              â”‚   stdout    â”‚       â”‚  workspace  â”‚  â”‚
â”‚              â”‚ JSON events â”‚       â”‚   (mount)   â”‚  â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                     â”‚
                      â–¼                     â–¼
              Your Application        Host Filesystem
              (event consumer)        (controlled dir)
```

**System Interface:**
- **stdout (JSON events)**: Only output channel. Application parses events and decides actions.
- **Workspace mount**: Only filesystem interface. Confined to a single directory.

**âš ï¸ Critical: These interfaces are NOT trust boundaries:**

- **Workspace volume**: Skills can read ALL data in the mounted workspace. Do not mount directories containing secrets, credentials, or sensitive data. The workspace is shared with untrusted code.
- **stdout (JSON events)**: Events are generated by untrusted code (LLM + Skills). Your application MUST treat event content as untrusted input:
  - Sanitize before logging (terminal control characters, ANSI escapes)
  - Validate JSON structure before parsing
  - Guard against log injection attacks
  - Set size limits to prevent DoS via large outputs

**Network Interface (Perstack on Docker):**
- All traffic forced through Squid proxy
- Only HTTPS allowed (HTTP blocked)
- Only allowedDomains + provider API accessible
- Internal IPs blocked (RFC 1918, loopback, link-local, cloud metadata)

---

## Multi-Runtime Support

Perstack supports multiple runtimes. Security controls vary by runtime:

| Runtime       | Security Layer                                                                |
| ------------- | ----------------------------------------------------------------------------- |
| `docker`      | Perstack on Docker (full sandbox + Squid proxy) â€” **default**                 |
| `local`       | perstack.toml-level controls only (requiredEnv, pick/omit, context isolation) |
| `cursor`      | Cursor's own security                                                         |
| `claude-code` | Claude Code's own security                                                    |
| `gemini`      | Gemini's own security                                                         |

**Note:** The security features described in this document (container isolation, Squid proxy, DNS rebinding protection) apply **only to the default Docker runtime**. The `local` runtime provides no isolation â€” use it only for trusted environments. Other runtimes delegate security to their own implementations.

---

## Runtime Security Comparison

| Security Control       | Docker (default)           | Local                  |
| ---------------------- | -------------------------- | ---------------------- |
| Network Isolation      | âœ… Squid proxy allowlist    | âŒ Unrestricted         |
| Filesystem Isolation   | âœ… Container sandbox        | âŒ Full access          |
| Capability Dropping    | âœ… All capabilities dropped | âŒ Full capabilities    |
| Non-root Execution     | âœ… Runs as `perstack` user  | âŒ Runs as current user |
| Env Variable Filtering | âœ… Strict whitelist         | âœ… Strict whitelist     |
| Read-only Root FS      | âœ… Enabled                  | âŒ N/A                  |
| Resource Limits        | âœ… Memory/CPU/PID limits    | âŒ Unlimited            |
| DNS Rebinding Block    | âœ… Internal IPs blocked     | âŒ N/A                  |

**Why Docker is the default runtime?** It provides:
- Container isolation (filesystem, network, capabilities)
- Squid proxy with domain allowlist
- DNS rebinding protection
- Resource limits (memory, CPU, PIDs)

---

## Perstack on Docker Security Features

### Network Isolation

Outbound network access is restricted by a Squid proxy:
- Only domains in `allowedDomains` are accessible
- Provider API domains (e.g., api.anthropic.com) are auto-included
- All traffic must go through the proxy (HTTP_PROXY enforced)
- **HTTPS only**: All non-CONNECT (HTTP) requests are blocked

**Why HTTPS Only?**

Unencrypted HTTP traffic poses severe security risks:
- Data exfiltration could occur without encryption
- Man-in-the-middle attacks could intercept sensitive data
- Agents should never transmit user data over unencrypted channels

The proxy explicitly denies all non-CONNECT requests (`http_access deny !CONNECT`), ensuring only HTTPS traffic is allowed.

**DNS Rebinding Protection:** The following IP ranges are explicitly blocked:

IPv4:
- `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16` (RFC 1918 private)
- `127.0.0.0/8` (loopback)
- `169.254.0.0/16` (link-local, cloud metadata endpoints)

IPv6:
- `::1/128` (loopback)
- `fe80::/10` (link-local)
- `fc00::/7` (unique local addresses)

### Filesystem Isolation

- Container has its own filesystem
- Workspace is mounted as a volume
- Host files (SSH keys, AWS credentials) are not accessible
- Read-only root filesystem with tmpfs for write operations

### Privilege Restrictions

- All Linux capabilities dropped (`cap_drop: ALL`)
- No new privileges allowed (`no-new-privileges: true`)
- Non-root user (`perstack`)
- No access to Docker socket

### Resource Limits

Container resources are constrained to prevent denial of service:
- Memory: 2GB limit, 256MB reservation
- CPU: 2 cores maximum
- Processes: 256 maximum (pids limit)

**Disk quota:** Docker does not enforce per-container disk quotas by default. Perstack mitigates this via:
- Read-only root filesystem (writes only to tmpfs and workspace mount)
- tmpfs has implicit size limits (defaults to 50% of host RAM)

**Infrastructure responsibility:** For production deployments, operators should:
- Use overlay2 storage driver with `--storage-opt size=XXG` for container layer limits
- Set appropriate quotas on the workspace mount volume
- Monitor disk usage and set alerts
- Consider ephemeral container orchestration (ECS, K8s) that cleans up after execution

### Environment Variable Handling

Perstack filters environment variables to prevent accidental secret leakage.

**Runtime-Specific Variables:**

| Variable Category                          | Docker (default)   | Local        | Notes                                        |
| ------------------------------------------ | ------------------ | ------------ | -------------------------------------------- |
| `PATH, HOME, SHELL`                        | âœ…                  | âœ…            | Required for process execution               |
| `TERM`                                     | âœ…                  | âœ…            | Terminal compatibility                       |
| `NODE_PATH`                                | âœ…                  | âœ…            | Node.js module resolution (âš ï¸ attack surface) |
| `HTTP_PROXY, HTTPS_PROXY`                  | âœ… (proxy enforced) | âŒ Not passed | Docker only: forces proxy                    |
| `NO_PROXY, PERSTACK_PROXY_URL`             | âœ…                  | âŒ Not passed | Docker only                                  |
| `NPM_CONFIG_PROXY, NPM_CONFIG_HTTPS_PROXY` | âœ…                  | âŒ Not passed | Docker only: npm proxy                       |

**âš ï¸ NODE_PATH risk:** Included for compatibility, but allows skills to influence module resolution. In `local` runtime with no filesystem isolation, this increases attack surface.

**Protected Variables (cannot be overridden via tool inputs):**

The following variables are blocked from being set or overridden via the `exec` tool's `env` parameter. Matching is **case-insensitive** to prevent bypass via `Path` or `pAtH`.

```
PATH, HOME, SHELL, NODE_PATH
LD_PRELOAD, LD_LIBRARY_PATH (Linux library injection)
DYLD_INSERT_LIBRARIES, DYLD_LIBRARY_PATH (macOS library injection)
NODE_OPTIONS, PYTHONPATH, PERL5LIB, RUBYLIB (interpreter paths)
```

**Scope:** This protection applies only to the `exec` tool in `@perstack/base`. MCP skills are untrusted code and can set arbitrary environment variables for their own child processes.

**Skill-Requested Variables:**

Skills can request additional environment variables via `requiredEnv`:

```toml
[experts."my-expert".skills."my-skill"]
requiredEnv = ["MY_API_KEY"]
```

**Security Warning:** Variables in `requiredEnv` are passed directly to the skill process. Only provide API keys to trusted skills.

---

## Known Limitations

This section documents what Perstack **cannot** prevent, even with `--runtime docker`.

### Network Control Bypass Vectors

Network controls are defense-in-depth, not perfect boundaries. Be aware of:

- **IPv6**: Ensure IPv6 is properly blocked or filtered
- **Punycode/IDN**: Homograph attacks via internationalized domain names
- **Wildcard handling**: Subdomain enumeration and unexpected matches
- **DoH/DoT**: DNS-over-HTTPS/TLS can bypass DNS-level filtering
- **SNI vs certificate**: Proxy validates SNI, not the actual certificate chain
- **Proxy env var override**: Skills could attempt to override HTTP_PROXY (blocked by protected variables)

**Best practice:** Use the smallest possible `allowedDomains` list. Default to deny.

### DNS Exfiltration Channels

Squid proxy blocks HTTP/HTTPS responses but does not intercept DNS queries. A malicious skill could:

- Encode secrets in DNS query subdomains (e.g., `secretdata.attacker.com`)
- Use DNS TXT record lookups for bidirectional communication
- Exfiltrate data via DNS query patterns

**What Perstack blocks:**

- HTTP/HTTPS responses from non-allowedDomains (via Squid proxy)
- The response to any HTTP request to attacker-controlled domains

**What Perstack does NOT block:**

- DNS queries themselves (the query is sent even if the HTTP response is blocked)
- Data encoded in the DNS query string reaching the attacker's DNS server

**Mitigation:** For highly sensitive environments, deploy additional DNS-level filtering at the infrastructure level (e.g., DNS firewall, restricted DNS resolver).

### Windows Platform Limitations

> **ðŸš¨ Windows Security Warning**
>
> Windows lacks critical security primitives (`O_NOFOLLOW`, robust symlink restrictions). If you run untrusted Experts from the internet on Windows, **use the default Docker runtime via WSL2**.
>
> ```bash
> # Secure execution on Windows (default)
> perstack run expert-name "query"
> ```
>
> Running untrusted Experts with the `local` runtime on Windows is **strongly discouraged** and may expose your system to arbitrary file access and code execution.

### Command Execution Limitations

The `exec` tool in `@perstack/base` reduces attack surface but does not provide isolation:

- **execFile (not exec):** Reduces shell metacharacter attack risk. However, the executed command itself is still untrusted and can perform arbitrary operations.
- **No Shell Initialization:** `execFile` bypasses shell, so `BASH_ENV`, `ENV`, `IFS`, `CDPATH` have no effect
- **Protected Variables:** Blocks override of PATH, LD_PRELOAD, etc. (case-insensitive matching)
- **Default Timeout:** 60 seconds unless overridden
- **Path Validation:** Working directory must be within workspace

**Not prevented:** The command itself can still access files outside workspace (e.g., `cat /etc/passwd`), make network requests, or perform other operations allowed by the process. The default `docker` runtime provides actual isolation.

### File Operation Limitations

File operations in `@perstack/base` reduce symlink attack risk but do not eliminate it:

- **O_NOFOLLOW:** File operations use this flag to avoid following symlinks (Linux/macOS only)
- **Symlink Detection:** `lstat` checks detect symbolic links before operations
- **Path Validation:** Paths resolved via `realpath` and checked against workspace boundary
- **TOCTOU Mitigation:** Combined checks reduce (but do not eliminate) race condition windows

**Not prevented:** A malicious skill running in the same process can race against these checks or create symlinks. The default `docker` runtime with read-only root filesystem provides actual isolation.

### Disk Quota Not Enforced

Docker does not enforce per-container disk quotas by default. A malicious skill could fill the host disk via:
- Writing to tmpfs (limited by RAM)
- Writing to workspace mount (limited only by host filesystem)

**Mitigation:** Operators must configure disk quotas at the infrastructure level.

---

## Security Checklist

### Before Running Experts

- [ ] Review the `perstack.toml` configuration
- [ ] Check which skills are referenced
- [ ] Review `requiredEnv` for each skill
- [ ] Verify skill sources (npm packages, custom commands)
- [ ] Use the default `docker` runtime (avoid `--runtime local` for untrusted Experts)

### For Production Deployment

- [ ] Use the default `docker` runtime
- [ ] Configure `allowedDomains` as minimal as possible
- [ ] Use minimal `requiredEnv` sets
- [ ] **Never mount directories containing secrets into workspace**
- [ ] Treat stdout events as untrusted input (sanitize before logging)
- [ ] Enable logging for audit purposes
- [ ] Set appropriate `maxSteps` limits
- [ ] Use read-only workspace mounts where possible

### For Skill Authors

- [ ] Request only necessary environment variables
- [ ] Document what each variable is used for
- [ ] Do not log or transmit secrets
- [ ] Use HTTPS for all external communications
- [ ] Handle errors without exposing sensitive data

---

## Reporting Vulnerabilities

If you discover a security vulnerability, please report it responsibly:

1. **Do not** open a public GitHub issue
2. Email security concerns to: masaaki.hirano@wintermute.llc
3. Include:
   - Description of the vulnerability
   - Steps to reproduce
   - Potential impact
   - Suggested fix (if any)

We aim to acknowledge reports promptly and will work with you to resolve the issue. Response times may vary based on severity and maintainer availability.

---

## Audit History

| Date       | Versions                                                                | Auditor     | Summary                                                              | Report                                                                       |
| ---------- | ----------------------------------------------------------------------- | ----------- | -------------------------------------------------------------------- | ---------------------------------------------------------------------------- |
| 2024-12-15 | core@0.0.23, runtime@0.0.66, base@0.0.33, docker@0.0.1, perstack@0.0.46 | AI (Claude) | First audit. 0 Critical, 0 High, 2 Medium, 3 Low. Ready for release. | [Report](./.agent/reports/audit-reports/2024-12-15T12-00-00_audit_report.md) |

---

## Acknowledgments

Security is a continuous process. We thank everyone who has contributed to improving Perstack's security posture through responsible disclosure and code review.
